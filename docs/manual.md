ISUCON9 予選マニュアル
===

# はじめに

## スケジュール

- 10:30 競技開始(適当です)
- 17:30 競技終了(適当です)

## ルール
webappディレクトリ以下のみ変更して良い。  
- DBスキーマの変更やインデックスの作成・削除
- データベースに利用するミドルウェアの変更
など基本何してもいいです。困ったら質問してください

競技における高速化対象のアプリケーションとして与えられたアプリケーションから、以下の部分は変更しないこと。  
- アクセス先のURI、ただしサーバー側で生成する部分（IDなど）は文字種（[0-9] や [0-9a-zA-Z_] など）を変えない範囲で自由に生成しても良い
- レスポンス(HTML)のDOM構造（表示に影響しない範囲での空白文字の増減は許可される）
- JavaScript/CSSファイルの内容
- 画像および動画等のメディアファイルの内容

## アプリケーションの動作確認

READMEに従ってアプリケーションを起動後(8000 port)、
`GET /` へアクセスすることでトップページにアクセスすることができます。
画面の「新規会員登録」から、ユーザを作成あるいは以下のテスト用ユーザが利用できます

| id       | password |
|----------|----------|
| isudemo1 | isudemo1 |
| isudemo2 | isudemo2 |
| isudemo3 | isudemo3 |


## リカバリ方法

DB(isucari)を初期状態にもどすには、次のコマンドを実行します。

```sh
$ webapp/sql/init.sh
```

## ［開発用］shipmentおよびpayment serviceの利用について

アプリケーションを開発・確認する際に、利用可能なshipmentおよびpayment serviceを用意しています。以下の手順で利用することができます。

またAPIの詳細は「外部サービスAPIの仕様」 `webapp/docs` 以下の **EXTERNAL_SERVICE_SPEC.md** を参照してください。

# ISUCARIについて

## ストーリー

ISUCARIは椅子を売りたい人／買いたい人をつなげるフリマアプリです。

- 日々開発が進められ、先日もBump機能がリリースされたばかり
- 世界的な椅子ブームを追い風に順調に成長を続け
- さらなる成長を見込み社長は自腹による「ｲｽｺｲﾝ還元キャンペーン」を企画
- しかし「ｲｽｺｲﾝ還元キャンペーン」の驚異的な拡散力により負荷に耐えられないことが発覚
- 社長「緊急メンテナンスをいれていいので18時までに改修しろ。18時にプロモーション開始だ」

## アプリケーションの仕様について

ISUCARIの使い方、紹介は「ISUCARI アプリケーション仕様書」 `webapp/docs` 以下の **APPLICATION_SPEC.md** を参照してください。

# ルール詳細

指定された競技用サーバーインスタンス上のアプリケーションのチューニングを行い、それに対するベンチマーク走行のスコアで競技を行います。
利用が認められた競技用サーバーのみでアプリケーションの動作が可能であれば、どのような変更を加えても構いません。

ベンチマーカーとブラウザの挙動に差異がある場合、ベンチマーカーの挙動を正とします。

また、初期実装は言語毎に若干の挙動の違いはありますが、ベンチマーカーに影響のない挙動に関しては仕様とします。

## 商品取得APIと更新の反映について

ISUCARIには以下の商品取得APIがあります。

- 新着一覧
- カテゴリ毎新着一覧
- ユーザ毎一覧
- 取引一覧
- 商品詳細

商品が出品・編集された場合は、カテゴリ毎新着一覧、ユーザ毎一覧、取引一覧、商品詳細APIに即座に反映してください。
編集・購入された商品については、全ての商品一覧・詳細取得APIで即座に情報を更新してください。
古いデータの削除、非表示はベンチマーク上で許可されません。各商品一覧取得APIが一度に返す商品数は初期実装と同じ状態を保つ必要があります。
新着一覧については、上記の制限を満たした上でよりユーザにあわせた商品の一覧を返すことで、購入の機会を増やすことができます。

## キャンペーン機能

`POST /initialize` のレスポンスにて、ｲｽｺｲﾝ還元キャンペーンの「還元率の設定」を返すことができます。この還元率によりユーザが増減します。

`POST /initialize` のレスポンスは JSON 形式で

```
{
    "campaign": 0,
    "language": "実装言語"
}
```

campaignが還元率の設定となります。有効な値は 0 以上 4 以下の整数で 0 の場合はキャンペーン機能が無効になります。

languageについては別の項目で説明しています。

なお、ｲｽｺｲﾝ還元の費用が下で説明するスコアから引かれることはありません。

## ベンチマーク走行

ベンチマーク走行は以下のように実施されます。

1. 初期化処理の実行 `POST /initialize`（20秒以内）
2. アプリケーション互換性チェックの走行（適宜: 数秒〜数十秒）
3. 負荷走行（60秒）
4. 負荷走行後の確認（適宜: 数秒〜数十秒）

各ステップで失敗が見付かった場合にはその時点で停止します。
ただし、負荷走行中のエラーについては、タイムアウトや500エラーを含む幾つかのエラーについては無視され、ベンチマーク走行が継続します。

また負荷走行が60秒行われた後、レスポンスが返ってきていないリクエストはすべて強制的に切断されます。
その際にnginxのアクセスログにステータスコード499が記録されることがありますが、これらのリクエストについては減点の対象外です。

## スコア計算

スコアは**取引が完了した商品（椅子）の価格の合計（ｲｽｺｲﾝ）** をベースに以下の計算式で計算されます。

```
取引が完了した商品（椅子）の価格の合計（ｲｽｺｲﾝ） - 減点 = スコア（ｲｽｺｲﾝ）
```

以下の条件のエラーが発生すると、失格・減点の対象となります。

- 致命的なエラー
  - 1回以上で失格
  - メッセージの最後に `(critical error)` が付与されます
- HTTPステータスコードやレスポンスの内容などに誤りがある
  - 1回で500ｲｽｺｲﾝ減点、10回以上で失格
- 一定時間内にレスポンスが返却されない・タイムアウト
  - 200回を超えたら100回毎に5000ｲｽｺｲﾝ減点、失格はなし
  - メッセージの最後に `（タイムアウトしました）` か `（一時的なエラー）` が付与されます

HTTPステータスコードは、基本的に参照実装と同一のものを想定しています。またベンチマーカーのメッセージは同一のメッセージを1つにまとめます。表示されているメッセージの数とエラー数は一致しないことがあります。

また減点により0ｲｽｺｲﾝ以下になった場合は失格となります。


## 制約事項

以下の事項に抵触すると失格(fail)となり、点数が0点になります。

- `POST /initialize` へのレスポンスを20秒以内に返さない場合
- アプリケーション互換性チェックに失敗した場合
- アプリケーションがレスポンスを10秒以内に返さない場合
- その他、ベンチマーカーのチェッカが失敗を検出したケース

最初に呼ばれる初期化処理 `POST /initialize` は用意された環境内で、チェッカツールが要求する範囲の整合性を担保します。
サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。

予選終了後に行われる主催者による確認作業（追試）において下記の点が確認できなかった場合は失格となります。

- アプリケーションは全て保存データを永続化する必要があります
  - 処理実施後に再起動が行われた場合、再起動前に行われた処理内容が再起動後に保存されている必要があります
- アプリケーションはブラウザ上での表示を初期状態と同様に保つ必要があります
- 以下に示す改変を行ってはなりません
  - パスワードを平文で保存する

## `POST /initialize` での実装言語の出力

`POST /initialize` のレスポンスにて、本競技で利用した言語を出力してください。集計しblogで公表したり、参考情報として利用させていただきます。

`POST /initialize` のレスポンスは次のような JSON 形式になります。

```
{
    "campaign": 0,
    "language": "実装言語"
}
```

languageの値が実装に利用した言語となります。languageが空の場合はベンチマーカーは失敗と見なされます。
